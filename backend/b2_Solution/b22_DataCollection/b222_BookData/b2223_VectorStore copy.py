import os
import json
import faiss
import numpy as np
from transformers import AutoTokenizer, AutoModel
import torch

# 경로 설정
data_directory = '/yaas/storage/s1_Yeoreum/s14_DataCollectionStorage/s142_BookData/s1423_YearlyBookData/2023년_YearlyBookData/'

# 모델 및 토크나이저 로드
tokenizer = AutoTokenizer.from_pretrained("sentence-transformers/all-MiniLM-L6-v2")
model = AutoModel.from_pretrained("sentence-transformers/all-MiniLM-L6-v2")

# 벡터 인코딩 함수
def encode_text(text):
    inputs = tokenizer(text, return_tensors="pt", padding=True, truncation=True)
    with torch.no_grad():
        embeddings = model(**inputs).last_hidden_state[:, 0, :]
    return embeddings.squeeze().cpu().numpy()

# JSON 파일 로드 및 벡터화
def load_and_encode_data(directory):
    vectors = []
    metadata = []
    for filename in os.listdir(directory):
        if filename.endswith('.json'):
            with open(os.path.join(directory, filename), 'r', encoding = 'utf-8') as file:
                data = json.load(file)
                text_to_encode = f"{data['Title']} {data['Author']} {data['Intro']}"
                vector = encode_text(text_to_encode)
                vectors.append(vector)
                metadata.append(data)
    return np.array(vectors), metadata

# 데이터 로드 및 벡터화
vectors, metadata = load_and_encode_data(data_directory)

# FAISS 인덱스 생성
dimension = vectors.shape[1]
index = faiss.IndexFlatL2(dimension)
index.add(vectors)

# 쿼리 데이터 로드 및 벡터화
query_data =     {
        "Rank": 200,
        "Date": "2024년 05월 3주",
        "ISBN": "9791189686987",
        "Title": "이상한 무인 편의점",
        "Author": "서아람 저자(글) · 안병현 그림/만화",
        "AuthorInfo": "서울대학교에서 법학을 전공하고 대한민국 검사로 일했습니다. 어린 시절부터 소설 읽기를 좋아해, 더 많은 이야기를 쓰고 싶어 지금은 변호사로 일하며 글을 쓰고 있습니다.\ntvN ‘유 퀴즈 온 더 블럭’에 검사 1호로 출연했고, CJ ENM과 카카오페이지가 주최한 추미스 공모전에서 『암흑 검사(전 2권)』로 우수상을, 밀크T 창작동화 공모전에서 「안내묘 치치」로 동상을 수상했습니다.\n지은 책으로는 『이상한 무인 아이스크림 가게』, 『이상한 무인 문구점』, 『지켜 줘요! 슈법맨 1, 2』, 『아빠가 된 아이돌(전 2권)』, 『여자 사람 검사』 등이 있습니다.\n이야기에 어울리는 그림을 만들고, 괜찮은 이야기를 그립니다.\n그린 책으로 『이상한 무인 아이스크림 가게』, 『이상한 무인 문구점』, 『크리처스』, 『도티가 로그인합니다』, 『위기의 역사』, 『세금 내는 아이들의 생생 경제 교실』, 『인 더 게임』, 『너에게서 온 봄』 등이 있습니다.",
        "Publish": "라곰스쿨",
        "PublishedDate": "2024년 03월 13일",
        "IntroCategory": [
            "국내도서",
            "어린이(초등)",
            "어린이문학",
            "동화책",
            "한국작가\n국내도서",
            "어린이(초등)",
            "초등1-6학년",
            "어린이문학",
            "동화책"
        ],
        "Intro": "★★★ 3만 독자가 기다린 ‘이상한 무인 가게’ 시리즈 ★★★\n★★★ 출간 전 해외 판권 수출 ★★★\n★★★ 서초구립반포도서관 추천 시리즈 ★★★\n★★★ 현직 초등학교 선생님·아동심리상담가 추천도서 ★★★\n\n“광선검 핫바ㆍ반짝반짝 물젤리\n순간 이동 번개몬 빵까지 꼭 필요한 물건만 팝니다!”\n신비한 물건이 가득한 무인 편의점이 열린다!\n3만 어린이 독자가 기다리고 현직 초등학교 선생님들이 추천하는 ‘이상한 무인 가게’ 시리즈가 『이상한 무인 편의점』으로 돌아왔다. 이번에는 먹을 것에서부터 생필품까지 갖가지 물건이 가득한 편의점을 배경으로 말 못 할 고민을 가진 아이들을 위한 신비로운 이야기를 전한다.\n어린이 사전 서평단이 “『전천당』보다 재미있는 책”이라고 강력 추천한 ‘이상한 무인 가게’ 시리즈의 세 번째 주제는 ‘성장’이다. 사람들 앞에서 발표하는 것이 두려운 아이에게는 ‘세치혀 달변가 불맛볶음면’을, 치과 치료가 세상에서 가장 싫은 아이에게는 ‘반짝반짝 다이아몬드 물젤리’를, 좀처럼 지각하는 습관을 고치지 못하는 아이에게는 ‘순간 이동 번개몬 빵’을 선물한다. 과연 아이들은 이곳에서 얻은 신비한 물건으로 자신의 고민을 해결하고 행복을 찾을 수 있을까.\n‘네이버 고민Q&A’에 올라온 실제 고민을 바탕으로 쓴 책이라 아이들과 더욱 친밀한 공감대를 형성해주는 책. 상상 속에나 존재할 법한 신비한 물건들은 우리 아이들의 ‘자존감 근육’을 튼튼하게 만들어줄 것이다.",
        "BookIndex": "무적 레이저 광선검 핫바\n반짝반짝 다이아몬드 물젤리\n스컹크 뿡뿡 너로구나 군고구마\n순간 이동 번개몬 빵\n자신감 뿜뿜 보조배터리\n무한메뉴 진수성찬 삼각김밥\n세치혀 달변가 불맛볶음면",
        "BookReviews": "출판사 서평\n“여러분에게 딱 필요한 물건만 팝니다”\n광선검 핫바, 반짝반짝 물젤리, 순간 이동 번개몬 빵까지\n마법의 무인 편의점이 열린다!\n\n3만 어린이 독자가 기다리고 현직 초등학교 선생님들이 추천하는 ‘이상한 무인 가게’ 시리즈가 『이상한 무인 편의점』으로 돌아왔다. 이번에는 먹을 것에서부터 생필품까지 갖가지 물건이 가득한 편의점을 배경으로 말 못 할 고민을 가진 아이들을 위한 신비로운 이야기를 전한다.\n『이상한 무인 아이스크림 가게』에서는 달콤한 아이스크림으로, 『이상한 무인 문구점』에서는 신비한 문구류로 아이들의 마음을 어루만져줬다면, 이번 편에서는 젤리에서부터 핫바, 삼각김밥까지 누구나 좋아하는 편의점으로 아이들을 초대한다. 사람들 앞에서 발표하는 것이 두려운 아이에게는 ‘세치혀 달변가 불맛볶음면’을, 치과 치료가 세상에서 가장 싫은 아이에게는 ‘반짝반짝 다이아몬드 물젤리’를, 좀처럼 지각하는 습관을 고치지 못하는 아이에게는 ‘순간 이동 번개몬 빵’을 선물하는 이상한 무인 편의점. 과연 아이들은 이곳에서 얻은 신비한 물건으로 자신의 고민을 해결하고 행복을 찾을 수 있을까.\n성적, 외모, 친구, 가족, 미래까지 ‘네이버 고민Q&A’에 올라온 아이들의 진짜 고민을 바탕으로 쓴 책! “무제한 사용 가능한 당당함을 선물하는 책”이라는 현직 초등학교 선생님과 아동심리상담가의 추천사처럼 이 책은 우리 아이들의 튼튼한 ‘자존감 근육’을 만들어줄 것이다.\n\n“이것만은 꼭 기억해. 진짜 중요한 건 네 마음이야”\n고민을 안고 살아가는 법을 알려주는 이야기\n\n고민 있는 아이들 앞에만 나타난다는 ‘이상한 무인 가게’는 이번 책 『이상한 무인 편의점』에서도 아이들에게 마법의 물건을 선물한다. 하지만 아이들은 신비한 물건을 얻는다고 모든 고민이 한번에 해결되는 것은 아님을 깨닫는다.\n순식간에 고민이 해결된 아이들은 처음에는 즐거워하지만, 신비한 힘을 사용하며 깨닫는 건 이 세상에 마법처럼 사라지는 고민은 없다는 것이다. 지금 당장은 해결될지 몰라도 그것이 또 다른 고민이 되어 돌아오고, 쉽게 얻은 것은 더 큰 어려움을 가져온다는 것을 말이다. “이것만은 꼭 기억해. 진짜 중요한 건 네 마음이야”라는 무인 편의점 스피커 속 목소리의 말처럼 모든 건 마음먹기에 달려 있음을 배운다.\n“아이들이 가장 좋아하는 공간에서 아이들은 물론 어른들도 함께 치유받는 성장 소설”이라는 박수현 선생님(제주동광초등학교)의 추천사처럼 이 책은 우리 아이들이 슬기롭게 성장통을 겪어내며, 한 뼘 더 성장할 수 있는 발판이 되어준다.\n\n네이버 고민Q&A에서 건져 올린 아이들의 진짜 속마음\n현직 교사, 학부모, 아동심리상담가 등 전문가가 추천하는 책\n\n이 책에 등장하는 아이들의 이야기는 실제 ‘네이버 고민Q&A’에 아이들이 직접 올린 고민의 글에서 출발했다. 특히 이번 책 『이상한 무인 편의점』에서 다루는 고민은 ‘성장’이다. 혼자 하교하는 것이 두려운 대형이, 치과 가는 것이 너무 싫은 채윤이, 사람들 앞에만 서면 말이 잘 안 나와 고민인 한결이까지 어린 시절 누구나 한 번쯤 하는 고민이지만 도전과 실패를 반복하며 극복할 수 있는 것들에 대한 이야기다.\n검사 시절, 검사실을 찾은 많은 청소년들을 만나며 그들의 고민을 진지하게 들어주는 것만으로도 많은 문제가 해결될 수 있다는 것을 몸소 체험한 서아람 작가는 아이들의 고민을 진지하게 들어주고자 이 책을 썼다. “적지 않은 아이들이 콤플렉스로 인해 마음이 아프기 시작한다”며 “이 책은 재미있는 이야기 속에서 우리 아이들의 자존감 근육이 보다 더 튼튼하게 성장하도록 도와줄 것”이라고 추천의 글을 쓴 최유진 아동심리상담가의 말처럼 이 책은 우리 아이들에게 위로받고 한 뼘 더 성장하는 시간을 선물해줄 것이다.\n\n**\n\n[추천의 글]\n\n아이들 상담을 하다 보면, 적지 않은 아이들이 콤플렉스로 인해 마음이 아프기 시작한다는 것을 알게 됩니다. 어른들의 역할은 평가하고 비교하는 것이 아닌 원래부터 훌륭하고 멋진 마음을 가진 아이들의 모습을 수용하는 것입니다. 이 책은 우리 아이들에게 무제한 사용 가능한 당당함을 선물합니다. 재미있는 이야기 속에서 우리 아이들의 자존감 근육이 보다 더 튼튼하게 성장하길 바랍니다.\n_ 최유진(아동심리상담가, 헬로스마일 동탄점 대표)\n\n어른들의 눈에는 작은 고민이지만, 의외로 아이들에게는 인생에서 꽤 큰 고민일 때가 있습니다. 이때 중요한 건, 아이들의 이야기를 진지하게 들어주고 함께 고민해 주는 것이지요. 상상 속에서나 존재할 법한 물건들과 함께 아이들에게 해방감을 선물하는 책, 어린이 친구들에게 적극 추천합니다.\n_김영희(세종초등학교 교사)\n\n친구들에게 인기를 얻고 싶고, 구두쇠 엄마가 부끄럽고, 아픈 반려동물과 헤어지고 싶지 않은 친구까지 『이상한 무인 가게』 시리즈에는 관계에 대한 아이들의 소망이 담겨 있습니다. 아이들이 가장 좋아하는 공간에서 아이들은 물론 어른들도 치유받는 성장 소설입니다.\n_박수연(제주동광초등학교)\n\n말 못 할 고민을 가진 아이들의 이야기. 나라면 어떤 것을 원할지 생각해 본다. 이 책은 마법의 물건이 지금 당장 나의 고민을 해결해 줄 수 있을지는 몰라도, 그것이 또 다른 고민이 되어 돌아온다는 것을 알려 준다. “이 세상에 공짜는 없단다”라고 했던 책 속 구절처럼 세상에 쉽게 얻어지는 것은 없다. 현재 나의 모습을 사랑하고, 가진 것들을 소중히 여기며 살아가는 것. 앞으로 아이와 함께 많은 책을 읽겠지만, 가장 먼저 생각나는 책이 될 것 같다.\n_박정화(함박초등학교 6학년 김효림 학부모)\n\n이제 집 앞 무인 아이스크림 가게에서 아이스크림을 고를 때마다 소원을 빌게 된다. 항상 바쁜 우리 엄마가 세 명이 되었으면 좋겠다고. 내 마음에 마법을 거는 책이다.\n_정이안(압구정초등학교 3학년)\n\n이 책은 고민이 있는 아이들의 안타까운 사정과 소소한 행복이 함께하는 책이에요. 이야기 속 친구들이 걱정되기도 하고, 다음엔 어떤 이야기가 펼쳐질지 기대되어서 시간 가는 줄도 모르고 재미있게 읽었어요.\n_류하진(서강초등학교 4학년)\n\n나는 이 책에 나오는 가게들이 참 신기했다. 특히 날씬해지는 소원을 들어주는 아이스크림이 가장 재미있었다. 나도 이상한 무인 아이스크림 가게에 꼭 가 보고 싶다.\n_이주윤(잠실초등학교 2학년)",
        "BookPurchasedList": [
            {
                "title": "수학리더 기본 초등 수학 5-1(2024)",
                "author": ""
            },
            {
                "title": "대저택의 수상한 침입자",
                "author": "김지균. 권수영. 집사TV"
            },
            {
                "title": "이상한 무인 문구점",
                "author": "서아람. 안병현"
            },
            {
                "title": "책 먹는 여우의 봄 이야기",
                "author": "프란치스카 비어만. 송순섭"
            },
            {
                "title": "이상한 무인 아이스크림 가게",
                "author": "서아람. 안병현"
            },
            {
                "title": "최악의 최애",
                "author": "김다노. 남수현"
            },
            {
                "title": "세 발 고라니 푸푸",
                "author": "신이비. 신이비. 이장미"
            },
            {
                "title": "온 더 볼 3: 패스",
                "author": "성완. 돌만"
            },
            {
                "title": "Who? 리오넬 메시: 특별판",
                "author": "최재훈. 툰쟁이"
            },
            {
                "title": "최태성의 한능검 한국사 1: 구석기 시대~청동기 시대",
                "author": "윤상석. 이태영. 최태성"
            },
            {
                "title": "한밤중 달빛 식당(30주년 기념 리커버 특별판)",
                "author": "이분희. 윤태규"
            },
            {
                "title": "[친필사인본 추첨행사 전용도서] 말량&홍챠 인피니티 1: VS 랜덤 대결 플레이",
                "author": "한효재. 최원선. 샌드박스네트워크. 말량&홍챠"
            },
            {
                "title": "변호사 어벤저스 1",
                "author": "고희정. 최미란. 신주영"
            },
            {
                "title": "무한의 계단 수수께끼 아일랜드 1",
                "author": "한바리. 세이. 무한의 계단"
            },
            {
                "title": "수상한 이웃집 시노다 1: 똑똑! 옆집 여우인데요",
                "author": "도미야스 요코. 송지현. 오바 켄야"
            },
            {
                "title": "꽝 없는 뽑기 기계(봄 에디션)(리커버:K)",
                "author": "곽유진. 차상미"
            }
        ],
        "CommentList": [
            {
                "comment": "아이가 재밌게 잘 읽었습니다.",
                "like": "0"
            },
            {
                "comment": "내용이 재밌는지 아이가 재밌게 잘 읽었습니다.",
                "like": "0"
            },
            {
                "comment": "이상한 시리즈 아이가 좋아하네요",
                "like": "0"
            },
            {
                "comment": "잘 보았어요 시리즈 즐거워하네요",
                "like": "0"
            },
            {
                "comment": "요즘 이역 시리즈 푹 빠져서 잘 읽었습니다",
                "like": "0"
            },
            {
                "comment": "잘 보고 있습니다.",
                "like": "0"
            },
            {
                "comment": "추천받아서 샀습니다 ^^",
                "like": "0"
            },
            {
                "comment": "다음편 기대합니다.",
                "like": "0"
            },
            {
                "comment": "다음은 어떤 무인 시리즈가 나올까 기대하네요.ㅎㅎ",
                "like": "0"
            },
            {
                "comment": "좋아요 잘읽었습니다",
                "like": "0"
            }
        ]
    }

query_text = f"{query_data['Title']} {query_data['Author']} {query_data['Intro']}"
query_vector = encode_text(query_text).reshape(1, -1)

# 유사도 검색
D, I = index.search(query_vector, k=5)

# 결과 출력
similar_books = [metadata[i] for i in I[0]]

import pandas as pd
df = pd.DataFrame(similar_books)
print(df)